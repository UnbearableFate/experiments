import numpy as np
import time

import numpy as np
from scipy.stats import norm

# 已知参数 2.678 / 49 * 20%
e_value = 0.05  # 设置期望值 e
k = 3        # 希望 P(X > 3e) < 1%
p = 0.0625     # 概率阈值

# 标准正态分布分位数
z_p = norm.ppf(1 - p)

# 解方程求 sigma
ln_k = np.log(k)

# 定义要解的方程
def equation(sigma):
    return ln_k / sigma + sigma / 2 - z_p

# 使用数值方法求解 sigma
from scipy.optimize import fsolve

sigma_initial_guess = 1
sigma_solution = fsolve(equation, sigma_initial_guess)[0]

# 计算 mu
mu = np.log(e_value) - (sigma_solution**2) / 2

# 验证结果
E_X = np.exp(mu + (sigma_solution**2) / 2)
prob = 1 - norm.cdf((np.log(k * e_value) - mu) / sigma_solution)

print(f"计算得到的 sigma: {sigma_solution}")
print(f"计算得到的 mu: {mu}")
print(f"验证期望值 E[X]: {E_X}")
print(f"验证概率 P(X > {k}e): {prob * 100:.2f}%")

T = 0.04  # 假设正常设备的执行时间为 1 秒

delay_list = []

# 生成延迟并应用
for i in range(16):
    delay = round(np.random.lognormal(mean=mu, sigma=sigma_solution),4)
    delay_list.append(delay)
print(delay_list)
print("max ",max(delay_list))

'''
20%
计算得到的 sigma: 1.1387709936149228
计算得到的 mu: -5.25356987393745
验证期望值 E[X]: 0.010000000000000005
验证概率 P(X > 3e): 6.25%
[0.0071, 0.0046, 0.0043, 0.0119, 0.0049, 0.0121, 0.0097, 0.0029, 0.0238, 0.0069, 0.0062, 0.0008, 0.0148, 0.0114, 0.0098, 0.0006]
max  0.0238

40%
计算得到的 sigma: 1.1387709936149228
计算得到的 mu: -4.560422693377506
验证期望值 E[X]: 0.019999999999999993
验证概率 P(X > 3e): 6.25%
[0.0009, 0.0031, 0.0159, 0.0018, 0.015, 0.0603, 0.0068, 0.0025, 0.0033, 0.0138, 0.0321, 0.0184, 0.0112, 0.0149, 0.0013, 0.0605]
max  0.0605

60%
计算得到的 sigma: 1.1387709936149228
计算得到的 mu: -4.154957585269341
验证期望值 E[X]: 0.029999999999999995
验证概率 P(X > 3e): 6.25%
[0.0311, 0.0176, 0.0288, 0.0139, 0.0399, 0.016, 0.0082, 0.1098, 0.0273, 0.0048, 0.0016, 0.0105, 0.0076, 0.0638, 0.0028, 0.0155]
max  0.1098

80%
计算得到的 sigma: 1.1387709936149228
计算得到的 mu: -3.8672755128175598
验证期望值 E[X]: 0.04000000000000001
验证概率 P(X > 3e): 6.25%
[0.0063, 0.0216, 0.1123, 0.0504, 0.0433, 0.0345, 0.0113, 0.0069, 0.0411, 0.0138, 0.0422, 0.0527, 0.0197, 0.0156, 0.0114, 0.0788]
max  0.1123

100%
计算得到的 sigma: 1.1387709936149228
计算得到的 mu: -3.64413196150335
验证期望值 E[X]: 0.05000000000000001
验证概率 P(X > 3e): 6.25%
[0.0506, 0.1451, 0.004, 0.0862, 0.0365, 0.0095, 0.046, 0.116, 0.0207, 0.0056, 0.0395, 0.0476, 0.0055, 0.0403, 0.0086, 0.0179]
max  0.1451

'''
